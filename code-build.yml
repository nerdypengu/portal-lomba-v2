trigger: none

pool:
  name: devasc-anisa

stages:
# Stage untuk Code Quality (ESLint, SonarQube)
- stage: CodeQuality
  jobs:
    - job: CodeQualityCheck
      steps:
      # Checkout code dari repository GitHub
      - checkout: self
        persistCredentials: true
        fetchDepth: 1
        clean: true

      # Setup Node.js
      - task: NodeTool@0
        displayName: 'Install Node.js'
        inputs:
          versionSpec: '20.x'

      # Install dependencies
      - script: |
          npm install
        displayName: 'Install Dependencies'

      # Install dependencies
      - script: |
          npm audit
        displayName: 'Install Dependencies'

      # Linting dengan fix
      - script: |
          npx eslint . --config client/eslint.config.js --fix --format json -o eslint-report.json
        displayName: 'Run ESLint with Fix and Report'
      
      # Publish report
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: 'eslint-report.json'
          ArtifactName: 'ESLint Report'
        displayName: 'Publish ESLint Report'

      - task: SonarQubePrepare@7
        inputs:
          SonarQube: 'SonarQube'
          scannerMode: 'cli'
          configMode: 'manual'
          cliProjectKey: 'FP-PSO-11_FP-PSO-11_AZPKLNXakXt54pvTXdAs'
          cliProjectName: 'portalomba'
          cliSources: '.'
          extraProperties: |
            sonar.branch.name=test-deploy

      - task: SonarQubeAnalyze@7
        inputs:
          jdkversion: 'JAVA_HOME'
          options: '-X'

      - task: SonarQubePublish@7
        inputs:
          pollingTimeoutSec: '300'